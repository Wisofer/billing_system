@model billing_system.Models.ViewModels.ReporteMensualViewModel
@{
    ViewData["Title"] = $"Reporte - {Model.PeriodoTexto}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Encabezado con botones de acci√≥n -->
<div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">üìä Reporte Mensual</h2>
        <p class="text-xl text-gray-600 dark:text-gray-400 font-semibold">@Model.PeriodoTexto</p>
    </div>
    
    <div class="flex gap-2 flex-wrap">
        <a href="/reportes/index" 
           class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow transition-all">
            ‚Üê Volver
        </a>
        <button onclick="window.print()" 
                class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-lg shadow transition-all">
            üñ®Ô∏è Imprimir
        </button>
        <a href="/reportes/exportarpdf?tipoFiltro=@ViewBag.TipoFiltro&mes=@ViewBag.Mes&a√±o=@ViewBag.A√±o&fechaInicio=@ViewBag.FechaInicio&fechaFin=@ViewBag.FechaFin"
           class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow transition-all">
            üìÑ Exportar PDF
        </a>
        <a href="/reportes/exportarexcel?tipoFiltro=@ViewBag.TipoFiltro&mes=@ViewBag.Mes&a√±o=@ViewBag.A√±o&fechaInicio=@ViewBag.FechaInicio&fechaFin=@ViewBag.FechaFin"
           class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow transition-all">
            üìä Exportar Excel
        </a>
    </div>
</div>

<!-- Resumen Ejecutivo -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 border-2 border-green-200 dark:border-green-700 rounded-xl p-6">
        <h3 class="text-sm font-semibold text-green-700 dark:text-green-300 uppercase mb-2">Total Ingresos</h3>
        <p class="text-3xl font-bold text-green-700 dark:text-green-200">C$ @Model.TotalIngresos.ToString("N2")</p>
        @if (Model.PorcentajeVariacionIngresos != 0)
        {
            <p class="text-xs mt-2 @(Model.PorcentajeVariacionIngresos > 0 ? "text-green-600" : "text-red-600")">
                @(Model.PorcentajeVariacionIngresos > 0 ? "‚ñ≤" : "‚ñº") @Math.Abs(Model.PorcentajeVariacionIngresos).ToString("F1")% vs periodo anterior
            </p>
        }
    </div>
    
    <div class="bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900 dark:to-red-800 border-2 border-red-200 dark:border-red-700 rounded-xl p-6">
        <h3 class="text-sm font-semibold text-red-700 dark:text-red-300 uppercase mb-2">Total Egresos</h3>
        <p class="text-3xl font-bold text-red-700 dark:text-red-200">C$ @Model.TotalEgresos.ToString("N2")</p>
        @if (Model.PorcentajeVariacionEgresos != 0)
        {
            <p class="text-xs mt-2 @(Model.PorcentajeVariacionEgresos > 0 ? "text-red-600" : "text-green-600")">
                @(Model.PorcentajeVariacionEgresos > 0 ? "‚ñ≤" : "‚ñº") @Math.Abs(Model.PorcentajeVariacionEgresos).ToString("F1")% vs periodo anterior
            </p>
        }
    </div>
    
    <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 border-2 border-blue-200 dark:border-blue-700 rounded-xl p-6">
        <h3 class="text-sm font-semibold text-blue-700 dark:text-blue-300 uppercase mb-2">Balance</h3>
        <p class="text-3xl font-bold @(Model.Balance >= 0 ? "text-blue-700 dark:text-blue-200" : "text-red-700 dark:text-red-200")">
            C$ @Model.Balance.ToString("N2")
        </p>
        <p class="text-xs mt-2 text-blue-600 dark:text-blue-400">Ingresos - Egresos</p>
    </div>
</div>

<!-- Ingresos por Categor√≠a -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
            Internet
        </h3>
        <div class="space-y-2">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Ingresos:</span>
                <span class="font-semibold text-gray-900 dark:text-white">C$ @Model.IngresosInternet.ToString("N2")</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Facturas:</span>
                <span class="font-semibold text-gray-900 dark:text-white">@Model.FacturasInternet</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Pendientes:</span>
                <span class="font-semibold text-amber-600 dark:text-amber-400">C$ @Model.PendientesInternet.ToString("N2")</span>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
            Streaming
        </h3>
        <div class="space-y-2">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Ingresos:</span>
                <span class="font-semibold text-gray-900 dark:text-white">C$ @Model.IngresosStreaming.ToString("N2")</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Facturas:</span>
                <span class="font-semibold text-gray-900 dark:text-white">@Model.FacturasStreaming</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Pendientes:</span>
                <span class="font-semibold text-amber-600 dark:text-amber-400">C$ @Model.PendientesStreaming.ToString("N2")</span>
            </div>
        </div>
    </div>
</div>

<!-- Estad√≠sticas Adicionales -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-4 text-center">
        <p class="text-2xl font-bold text-gray-900 dark:text-white">@Model.FacturasGeneradas</p>
        <p class="text-xs text-gray-600 dark:text-gray-400">Facturas Generadas</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-4 text-center">
        <p class="text-2xl font-bold text-green-600">@Model.FacturasPagadas</p>
        <p class="text-xs text-gray-600 dark:text-gray-400">Facturas Pagadas</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-4 text-center">
        <p class="text-2xl font-bold text-gray-900 dark:text-white">@Model.PagosRecibidos</p>
        <p class="text-xs text-gray-600 dark:text-gray-400">Pagos Recibidos</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-4 text-center">
        <p class="text-2xl font-bold text-blue-600">@Model.ClientesNuevos</p>
        <p class="text-xs text-gray-600 dark:text-gray-400">Clientes Nuevos</p>
    </div>
</div>

<!-- Tablas de Detalles (colapsables) -->
<div class="space-y-4">
    <!-- Facturas -->
    <details class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700" open>
        <summary class="cursor-pointer p-4 font-semibold text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
            üìã Facturas del Periodo (@Model.ListaFacturas.Count)
        </summary>
        <div class="p-4 overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">N√∫mero</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Cliente</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Fecha</th>
                        <th class="px-3 py-2 text-right text-gray-700 dark:text-gray-200 font-semibold">Monto</th>
                        <th class="px-3 py-2 text-center text-gray-700 dark:text-gray-200 font-semibold">Estado</th>
                        <th class="px-3 py-2 text-center text-gray-700 dark:text-gray-200 font-semibold">Categor√≠a</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    @foreach (var factura in Model.ListaFacturas)
                    {
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@factura.Numero</td>
                            <td class="px-3 py-2">
                                <div class="font-medium text-gray-900 dark:text-gray-100">@factura.ClienteNombre</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">@factura.ClienteCodigo</div>
                            </td>
                            <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@factura.Fecha.ToString("dd/MM/yyyy")</td>
                            <td class="px-3 py-2 text-right font-semibold text-gray-900 dark:text-gray-100">C$ @factura.Monto.ToString("N2")</td>
                            <td class="px-3 py-2 text-center">
                                <span class="px-2 py-1 rounded text-xs @(factura.Estado == "Pagada" ? "bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200" : "bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200")">
                                    @factura.Estado
                                </span>
                            </td>
                            <td class="px-3 py-2 text-center">
                                <span class="px-2 py-1 rounded text-xs @(factura.Categoria == "Internet" ? "bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200" : "bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200")">
                                    @factura.Categoria
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </details>

    <!-- Pagos -->
    <details class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <summary class="cursor-pointer p-4 font-semibold text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
            üí∞ Pagos Recibidos (@Model.ListaPagos.Count)
        </summary>
        <div class="p-4 overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Cliente</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Fecha</th>
                        <th class="px-3 py-2 text-right text-gray-700 dark:text-gray-200 font-semibold">Monto</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">M√©todo</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Referencia</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    @foreach (var pago in Model.ListaPagos)
                    {
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-3 py-2">
                                <div class="font-medium text-gray-900 dark:text-gray-100">@pago.ClienteNombre</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">@pago.ClienteCodigo</div>
                            </td>
                            <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@pago.Fecha.ToString("dd/MM/yyyy")</td>
                            <td class="px-3 py-2 text-right font-semibold text-green-600 dark:text-green-400">C$ @pago.Monto.ToString("N2")</td>
                            <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@pago.MetodoPago</td>
                            <td class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400">@pago.NumeroReferencia</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </details>

    <!-- Egresos -->
    <details class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <summary class="cursor-pointer p-4 font-semibold text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
            üí∏ Egresos del Periodo (@Model.ListaEgresos.Count)
        </summary>
        <div class="p-4 overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Concepto</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Fecha</th>
                        <th class="px-3 py-2 text-right text-gray-700 dark:text-gray-200 font-semibold">Monto</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Categor√≠a</th>
                        <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    @foreach (var egreso in Model.ListaEgresos)
                    {
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-3 py-2 font-medium text-gray-900 dark:text-gray-100">@egreso.Concepto</td>
                            <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@egreso.Fecha.ToString("dd/MM/yyyy")</td>
                            <td class="px-3 py-2 text-right font-semibold text-red-600 dark:text-red-400">C$ @egreso.Monto.ToString("N2")</td>
                            <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@egreso.Categoria</td>
                            <td class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400">@egreso.Descripcion</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </details>

    <!-- Clientes Nuevos -->
    @if (Model.ListaClientesNuevos.Any())
    {
        <details class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
            <summary class="cursor-pointer p-4 font-semibold text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg">
                üë• Clientes Nuevos (@Model.ListaClientesNuevos.Count)
            </summary>
            <div class="p-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">C√≥digo</th>
                            <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Nombre</th>
                            <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Fecha Creaci√≥n</th>
                            <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200 font-semibold">Servicios</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        @foreach (var cliente in Model.ListaClientesNuevos)
                        {
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-3 py-2 font-medium text-gray-900 dark:text-gray-100">@cliente.Codigo</td>
                                <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@cliente.Nombre</td>
                                <td class="px-3 py-2 text-gray-900 dark:text-gray-100">@cliente.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="px-3 py-2 text-xs text-gray-500 dark:text-gray-400">@cliente.Servicios</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </details>
    }
</div>

@section Scripts {
<style>
    /* Estilos para impresi√≥n */
    @@media print {
        /* Ocultar sidebar, header y botones al imprimir */
        aside, 
        header,
        .no-print,
        button,
        a[href*="volver"],
        a[href*="exportar"],
        .flex.gap-2.flex-wrap {
            display: none !important;
        }
        
        /* Ajustar m√°rgenes para impresi√≥n */
        body {
            margin: 0;
            padding: 20px;
        }
        
        /* Expandir todo el contenido */
        main {
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
        }
        
        /* Expandir todos los detalles colapsables */
        details {
            display: block !important;
        }
        
        details summary {
            display: none !important;
        }
        
        details > div {
            display: block !important;
            max-height: none !important;
        }
        
        /* Asegurar que las tablas se vean bien */
        table {
            page-break-inside: auto;
        }
        
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        
        /* Evitar saltos de p√°gina en elementos importantes */
        .bg-gradient-to-br,
        .bg-white {
            page-break-inside: avoid;
        }
    }
</style>
}


