<script>
function mostrarNombreArchivo(input) {
    const nombreArchivo = input.files[0]?.name || 'Seleccionar archivo Excel...';
    document.getElementById('nombreArchivo').textContent = nombreArchivo;
}

setTimeout(function() {
    const successMsg = document.getElementById('successMessage');
    const errorMsg = document.getElementById('errorMessage');
    const warningMsg = document.getElementById('warningMessage');
    if (successMsg) successMsg.style.display = 'none';
    if (errorMsg) errorMsg.style.display = 'none';
    if (warningMsg) warningMsg.style.display = 'none';
}, 5000);

// Reproducir sonidos de éxito / error si hay notificaciones
document.addEventListener('DOMContentLoaded', function () {
    try {
        const successMsg = document.getElementById('successMessage');
        const errorMsg = document.getElementById('errorMessage');

        if (successMsg) {
            const audioSuccess = new Audio('/sounds/success.mp3');
            audioSuccess.volume = 0.6;
            audioSuccess.play().catch(function () { /* ignorar errores de autoplay */ });
        } else if (errorMsg) {
            const audioError = new Audio('/sounds/error.mp3');
            audioError.volume = 0.6;
            audioError.play().catch(function () { /* ignorar errores de autoplay */ });
        }
    } catch (e) {
        console.error('Error reproduciendo sonido de notificación:', e);
    }
});

function abrirModalCrear() {
    const modal = document.getElementById('modalCrearCliente');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    generarCodigoCliente();
}

async function generarCodigoCliente() {
    try {
        const response = await fetch('/clientes/obtener-codigo');
        const data = await response.json();
        document.getElementById('codigoCliente').value = data.codigo;
    } catch (error) {
        console.error('Error al obtener código:', error);
        // Fallback: generar código aleatorio de 6 dígitos con formato EMS_XXXXXX
        const numeros = Math.floor(Math.random() * 900000) + 100000; // Número de 6 dígitos
        document.getElementById('codigoCliente').value = `EMS_${numeros}`;
    }
}

function cerrarModalCrear() {
    const modal = document.getElementById('modalCrearCliente');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    document.getElementById('formCrearCliente').reset();
    document.querySelectorAll('#formCrearCliente .text-red-500').forEach(el => el.textContent = '');
    document.getElementById('codigoCliente').value = '';
}

document.addEventListener('DOMContentLoaded', function() {
    // Manejar mostrar/ocultar campo de cantidad para todos los servicios (Internet y Streaming)
    const servicioCheckboxes = document.querySelectorAll('.servicio-checkbox');
    servicioCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const servicioItem = this.closest('.servicio-item');
            const cantidadContainer = servicioItem?.querySelector('.cantidad-container');
            
            if (cantidadContainer) {
                if (this.checked) {
                    cantidadContainer.classList.remove('hidden');
                } else {
                    cantidadContainer.classList.add('hidden');
                }
            }
        });
    });
    
    const form = document.getElementById('formCrearCliente');
    if (!form) return;
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const formData = new FormData(this);
        // Obtener todos los servicios seleccionados (checkboxes)
        const servicioIds = formData.getAll('ServicioIds').map(id => parseInt(id)).filter(id => !isNaN(id));
        const data = {
            Codigo: formData.get('Codigo') || '',
            Nombre: formData.get('Nombre') || '',
            Telefono: formData.get('Telefono') || null,
            Cedula: formData.get('Cedula') || null,
            Email: formData.get('Email') || null,
            ServicioId: servicioIds.length > 0 ? servicioIds[0] : null // Mantener compatibilidad
        };
        
        // Agregar los servicios seleccionados al FormData para enviarlos al servidor
        const formDataToSend = new FormData();
        formDataToSend.append('Codigo', data.Codigo);
        formDataToSend.append('Nombre', data.Nombre);
        if (data.Telefono) formDataToSend.append('Telefono', data.Telefono);
        if (data.Cedula) formDataToSend.append('Cedula', data.Cedula);
        if (data.Email) formDataToSend.append('Email', data.Email);
        
        // Agregar servicios con sus cantidades (para todos los servicios)
        servicioIds.forEach(id => {
            formDataToSend.append('ServicioIds', id.toString());
            // Obtener cantidad para todos los servicios (Internet y Streaming)
            const servicioItem = document.querySelector(`[data-servicio-id="${id}"]`);
            if (servicioItem) {
                    const cantidadInput = servicioItem.querySelector('.cantidad-input');
                    const cantidad = cantidadInput ? parseInt(cantidadInput.value) || 1 : 1;
                    formDataToSend.append(`Cantidad_${id}`, cantidad.toString());
            }
        });
        
        document.querySelectorAll('#formCrearCliente .text-red-500').forEach(el => el.textContent = '');
        
        try {
            const response = await fetch('/clientes/crear', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json'
                },
                body: formDataToSend
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const result = await response.json();
            
            if (result.success) {
                cerrarModalCrear();
                window.location.reload();
            } else {
                if (result.errors) {
                    Object.keys(result.errors).forEach(key => {
                        const errorElement = document.getElementById(`error-${key}`);
                        if (errorElement && result.errors[key] && result.errors[key].length > 0) {
                            errorElement.textContent = result.errors[key][0];
                        }
                    });
                } else if (result.message) {
                    await ModalDialog.alert(result.message, 'info');
                }
            }
        } catch (error) {
            console.error('Error completo:', error);
            await ModalDialog.alert('Error al crear el cliente: ' + error.message, 'error');
        }
    });
});

// Loader para importación de Excel
document.addEventListener('DOMContentLoaded', function() {
    const formImportarExcel = document.getElementById('formImportarExcel');
    const btnImportarExcel = document.getElementById('btnImportarExcel');
    const loaderImportarExcel = document.getElementById('loaderImportarExcel');
    const barraProgresoImportar = document.getElementById('barraProgresoImportar');
    const progresoImportarTexto = document.getElementById('progresoImportarTexto');
    const progresoImportarPorcentaje = document.getElementById('progresoImportarPorcentaje');
    const mensajeImportarProgreso = document.getElementById('mensajeImportarProgreso');
    
    // Función para contar filas en Excel usando FileReader
    async function contarFilasExcel(archivo) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    
                    // Intentar leer el archivo como ZIP (los .xlsx son archivos ZIP)
                    // Buscar el archivo xl/worksheets/sheet1.xml dentro del ZIP
                    // Esto requiere descomprimir el ZIP, lo cual es complejo sin librerías
                    
                    // Método alternativo: estimación inteligente basada en el tamaño
                    // Un archivo Excel .xlsx tiene overhead de ~10-20KB
                    // Cada fila de datos ocupa aproximadamente 300-600 bytes (depende de los datos)
                    const tamañoBytes = archivo.size;
                    const overheadEstimado = 15000; // ~15KB de overhead del Excel
                    const bytesPorFila = 450; // Promedio de bytes por fila
                    const filasEstimadas = Math.max(1, Math.floor((tamañoBytes - overheadEstimado) / bytesPorFila) - 1); // -1 por encabezado
                    
                    // Para archivos muy pequeños, usar una estimación mínima
                    if (filasEstimadas < 1) {
                        resolve(10); // Mínimo 10 filas estimadas
                    } else {
                        resolve(filasEstimadas);
                    }
                } catch (error) {
                    console.error('Error al contar filas:', error);
                    // Si falla, usar estimación conservadora
                    const tamañoBytes = archivo.size;
                    const estimacionConservadora = Math.max(10, Math.floor(tamañoBytes / 500));
                    resolve(estimacionConservadora);
                }
            };
            reader.onerror = function() {
                // Si falla la lectura, usar estimación basada en tamaño
                const tamañoBytes = archivo.size;
                const estimacion = Math.max(10, Math.floor(tamañoBytes / 500));
                resolve(estimacion);
            };
            reader.readAsArrayBuffer(archivo);
        });
    }
    
    if (formImportarExcel && btnImportarExcel && loaderImportarExcel) {
        formImportarExcel.addEventListener('submit', async function(e) {
            // Validar que haya un archivo seleccionado
            const archivoInput = document.getElementById('archivoExcel');
            if (!archivoInput || !archivoInput.files || archivoInput.files.length === 0) {
                e.preventDefault();
                ModalDialog.alert('Por favor selecciona un archivo Excel.', 'warning');
                return;
            }
            
            const archivo = archivoInput.files[0];
            
            // Deshabilitar el botón
            btnImportarExcel.disabled = true;
            btnImportarExcel.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Cambiar el contenido del botón
            const contenidoOriginal = btnImportarExcel.innerHTML;
            btnImportarExcel.innerHTML = `
                <svg class="w-4 h-4 animate-spin inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Importando...</span>
            `;
            
            // Mostrar el loader
            loaderImportarExcel.classList.remove('hidden');
            
            // Inicializar la barra de progreso
            let filasProcesadas = 0;
            let totalFilas = 0;
            
            // Contar filas del Excel
            try {
                totalFilas = await contarFilasExcel(archivo);
                if (progresoImportarTexto) {
                    progresoImportarTexto.textContent = `0 / ${totalFilas}`;
                }
                if (mensajeImportarProgreso) {
                    mensajeImportarProgreso.textContent = `Iniciando importación de ${totalFilas} cliente(s)...`;
                }
            } catch (error) {
                console.error('Error al contar filas:', error);
                // Usar estimación por defecto
                totalFilas = 100;
                if (progresoImportarTexto) {
                    progresoImportarTexto.textContent = `0 / ${totalFilas}`;
                }
            }
            
            // Calcular velocidad de procesamiento (filas por segundo)
            // Estimación: 5-20 filas por segundo dependiendo del tamaño
            const velocidadBase = totalFilas > 100 ? 15 : 10; // Más rápido para archivos grandes
            const intervaloMs = Math.max(50, Math.min(200, (totalFilas / velocidadBase) * 10)); // Ajustar velocidad
            
            // Simular progreso real: 1, 2, 3, 4... hasta totalFilas
            const intervaloProgreso = setInterval(function() {
                if (filasProcesadas < totalFilas) {
                    filasProcesadas++;
                    
                    // Calcular porcentaje
                    const porcentaje = Math.min(95, (filasProcesadas / totalFilas) * 100);
                    
                    // Actualizar barra de progreso
                    if (barraProgresoImportar) {
                        barraProgresoImportar.style.width = porcentaje + '%';
                    }
                    
                    // Actualizar porcentaje
                    if (progresoImportarPorcentaje) {
                        progresoImportarPorcentaje.textContent = Math.round(porcentaje) + '%';
                    }
                    
                    // Actualizar contador: 1 / 289, 2 / 289, etc.
                    if (progresoImportarTexto) {
                        progresoImportarTexto.textContent = `${filasProcesadas} / ${totalFilas}`;
                    }
                    
                    // Actualizar mensaje
                    if (mensajeImportarProgreso) {
                        mensajeImportarProgreso.textContent = `Procesando cliente ${filasProcesadas} de ${totalFilas}...`;
                    }
                } else {
                    // Si llegamos al total estimado, mantener en 95% hasta que termine realmente
                    const porcentaje = 95;
                    if (barraProgresoImportar) {
                        barraProgresoImportar.style.width = porcentaje + '%';
                    }
                    if (progresoImportarPorcentaje) {
                        progresoImportarPorcentaje.textContent = porcentaje + '%';
                    }
                    if (mensajeImportarProgreso) {
                        mensajeImportarProgreso.textContent = `Finalizando importación...`;
                    }
                }
            }, intervaloMs); // Velocidad ajustada según el total de filas
            
            // Limpiar intervalo cuando la página recargue
            window.addEventListener('beforeunload', function() {
                clearInterval(intervaloProgreso);
            });
            
            // El formulario se enviará normalmente
            // El loader se ocultará cuando la página recargue
        });
    }
});
</script>

