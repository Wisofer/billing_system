@model billing_system.Models.Entities.Pago
@using billing_system.Utils
@using System.Text.Json
@{
    ViewData["Title"] = "Registrar Pago";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var todosLosClientes = ViewBag.TodosLosClientes as List<billing_system.Models.Entities.Cliente> ?? new List<billing_system.Models.Entities.Cliente>();
    var tipoCambio = ViewBag.TipoCambio as decimal? ?? SD.TipoCambioCompra; // Usar Compra para pagos en $
    var bancos = ViewBag.Bancos as string[] ?? new[] { SD.BancoBanpro, SD.BancoLafise, SD.BancoBAC, SD.BancoFicohsa, SD.BancoBDF };
    var tiposCuenta = ViewBag.TiposCuenta as string[] ?? new[] { SD.TipoCuentaDolar, SD.TipoCuentaCordoba, SD.TipoCuentaBilletera };
    var clientesJson = JsonSerializer.Serialize(todosLosClientes.Select(c => new { id = c.Id, codigo = c.Codigo, nombre = c.Nombre }));
}

@if (TempData["Success"] != null)
{
    <div id="successMessage" class="mb-3 p-3 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-800 rounded text-green-700 dark:text-green-300 text-sm">
        @TempData["Success"]
    </div>
}

@if (TempData["Error"] != null)
{
    <div id="errorMessage" class="mb-3 p-3 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-800 rounded text-red-700 dark:text-red-300 text-sm">
        @TempData["Error"]
    </div>
}

<script>
// Reproducir sonidos de √©xito / error si hay notificaciones
document.addEventListener('DOMContentLoaded', function () {
    try {
        const successMsg = document.getElementById('successMessage');
        const errorMsg = document.getElementById('errorMessage');

        if (successMsg) {
            const audioSuccess = new Audio('/sounds/success.mp3');
            audioSuccess.volume = 0.6;
            audioSuccess.play().catch(function () { /* ignorar errores de autoplay */ });
        } else if (errorMsg) {
            const audioError = new Audio('/sounds/error.mp3');
            audioError.volume = 0.6;
            audioError.play().catch(function () { /* ignorar errores de autoplay */ });
        }
    } catch (e) {
        console.error('Error reproduciendo sonido de notificaci√≥n:', e);
    }
});

// Ocultar mensajes despu√©s de 5 segundos
setTimeout(function() {
    const successMsg = document.getElementById('successMessage');
    const errorMsg = document.getElementById('errorMessage');
    if (successMsg) successMsg.style.display = 'none';
    if (errorMsg) errorMsg.style.display = 'none';
}, 5000);
</script>

<div class="max-w-2xl mx-auto">
    <div class="mb-4">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Registrar Pago</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Sistema de pago r√°pido y sencillo</p>
    </div>

    <form method="post" action="/pagos/crear" id="formPago">
        @Html.AntiForgeryToken()
        
        <!-- Paso 1: Cliente -->
        <div id="paso1" class="paso-activo bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3 shadow-sm">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">1. Cliente</h3>
                <span id="clienteSeleccionadoBadge" class="hidden text-xs px-2 py-1 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded">‚úì Seleccionado</span>
            </div>
            <div class="relative">
                <input type="text" id="clienteSearch" autocomplete="off" placeholder="Buscar cliente..." 
                       class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-blue-500 focus:border-blue-500" />
                <input type="hidden" name="clienteId" id="clienteId" required />
                <div id="clienteDropdown" class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded shadow-lg max-h-48 overflow-y-auto hidden">
                    <div id="clienteDropdownContent"></div>
                </div>
            </div>
        </div>

        <!-- Paso 2: Facturas (oculto hasta seleccionar cliente) -->
        <div id="paso2" class="paso-oculto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3 shadow-sm">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">2. Facturas <span id="facturasSeleccionadasCount" class="text-xs font-normal text-gray-500">(0)</span></h3>
                <button type="button" id="btnSeleccionarTodas" class="hidden text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-800">Seleccionar todas</button>
            </div>
            <div id="facturasContainer" class="min-h-[120px] border border-gray-200 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-900 p-3">
                <p class="text-xs text-gray-500 dark:text-gray-400 text-center py-6" id="sinFacturasMensaje">Selecciona un cliente primero</p>
                <div id="facturasList" class="hidden space-y-2"></div>
            </div>
            <input type="hidden" name="FacturaId" id="FacturaId" />
            <input type="hidden" name="FacturaIds" id="FacturaIds" />
        </div>

        <!-- Paso 3: Monto y Moneda (oculto hasta seleccionar facturas) -->
        <div id="paso3" class="paso-oculto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3 shadow-sm">
            <div class="mb-3">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">3. Monto y Moneda</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Monto Total</label>
                        <input type="number" asp-for="Monto" name="Monto" step="0.01" min="0.01" required id="Monto"
                               class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white font-semibold" readonly />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Moneda</label>
                        <select asp-for="Moneda" name="Moneda" id="Moneda" required 
                                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="C$">C$ (C√≥rdobas)</option>
                            <option value="$">$ (D√≥lares)</option>
                            <option value="Ambos">Ambos (C$ y $)</option>
                        </select>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">TC: C$ @tipoCambio = $1</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 4: Tipo de Pago (oculto hasta tener monto) -->
        <div id="paso4" class="paso-oculto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3 shadow-sm">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">4. M√©todo de Pago</h3>
            <div class="grid grid-cols-3 gap-2">
                <label class="flex flex-col items-center p-3 border-2 border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:border-blue-400 dark:hover:border-blue-600 transition-all tipo-pago-option">
                    <input type="radio" name="TipoPago" value="Fisico" class="sr-only" />
                    <span class="text-xl mb-1">üíµ</span>
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">F√≠sico</span>
                </label>
                <label class="flex flex-col items-center p-3 border-2 border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:border-green-400 dark:hover:border-green-600 transition-all tipo-pago-option">
                    <input type="radio" name="TipoPago" value="Electronico" class="sr-only" />
                    <span class="text-xl mb-1">üí≥</span>
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Electr√≥nico</span>
                </label>
                <label class="flex flex-col items-center p-3 border-2 border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:border-purple-400 dark:hover:border-purple-600 transition-all tipo-pago-option">
                    <input type="radio" name="TipoPago" value="Mixto" class="sr-only" />
                    <span class="text-xl mb-1">üîÑ</span>
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Mixto</span>
                </label>
            </div>
        </div>

        <!-- Paso 5: Detalles del Pago (oculto hasta seleccionar tipo) -->
        <div id="paso5" class="paso-oculto">
            <!-- Pago F√≠sico -->
            <div id="camposFisico" style="display: none;" class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-3">
                <h4 class="text-xs font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                    <span class="mr-1">üíµ</span> Pago F√≠sico
                </h4>
                <!-- Fila 1: Monto (izquierda) y Recibido (derecha) -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div id="contenedorMontoFisico">
                        <div id="grupoMontoCordobasFisico">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1" id="labelMontoFisico1">Monto (C$)</label>
                            <input type="text" name="MontoCordobasFisico" id="MontoCordobasFisico" inputmode="decimal" 
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                                   placeholder="0.00" />
                        </div>
                        <div id="grupoMontoDolaresFisico" style="display:none;">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1" id="labelMontoFisico2">Monto ($)</label>
                            <input type="text" name="MontoDolaresFisico" id="MontoDolaresFisico" inputmode="decimal" 
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                                   placeholder="0.00" />
                        </div>
                    </div>
                    <div id="contenedorRecibidoFisico">
                        <!-- Campo √∫nico cuando es C$ o $ -->
                        <div id="grupoRecibidoUnico">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1" id="labelRecibidoFisico">Recibido (<span id="monedaRecibidoLabel">C$</span>)</label>
                            <input type="text" name="MontoRecibidoFisico" id="MontoRecibidoFisico" inputmode="decimal" 
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                                   placeholder="0.00" />
                            <div id="errorRecibidoFisico" class="hidden text-xs text-red-600 dark:text-red-400 mt-1"></div>
                        </div>
                        <!-- Campos separados cuando es Ambos -->
                        <div id="grupoRecibidoCordobasFisico" style="display:none;">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Recibido (C$)</label>
                            <input type="text" name="MontoRecibidoCordobasFisico" id="MontoRecibidoCordobasFisico" inputmode="decimal" 
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-2" 
                                   placeholder="0.00" />
                        </div>
                        <div id="grupoRecibidoDolaresFisico" style="display:none;">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Recibido ($)</label>
                            <input type="text" name="MontoRecibidoDolaresFisico" id="MontoRecibidoDolaresFisico" inputmode="decimal" 
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                                   placeholder="0.00" />
                            <div id="errorRecibidoFisicoAmbos" class="hidden text-xs text-red-600 dark:text-red-400 mt-1"></div>
                        </div>
                    </div>
                </div>
                <!-- Fila 2: Vuelto a lo ancho -->
                <div class="mb-2">
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Vuelto (C$)</label>
                    <input type="text" name="VueltoFisico" id="VueltoFisico" readonly 
                           class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300" 
                           value="0.00" />
                </div>
                <div class="text-xs text-right">
                    <span class="text-gray-600 dark:text-gray-400">Total: </span>
                    <span id="totalFisicoValor" class="font-semibold text-blue-600 dark:text-blue-400">C$ 0.00</span>
                </div>
            </div>

            <!-- Pago Electr√≥nico -->
            <div id="camposElectronico" style="display: none;" class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-3">
                <h4 class="text-xs font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                    <span class="mr-1">üí≥</span> Pago Electr√≥nico
                </h4>
                <!-- Fila 1: Monto (izquierda) y Banco (derecha) -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div id="grupoMontoCordobasElectronico">
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1" id="labelMontoElectronico1">Monto (C$)</label>
                        <input type="text" name="MontoCordobasElectronico" id="MontoCordobasElectronico" inputmode="decimal" 
                               class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                               placeholder="0.00" />
                    </div>
                    <div id="grupoMontoDolaresElectronico" style="display:none;">
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1" id="labelMontoElectronico2">Monto ($)</label>
                        <input type="text" name="MontoDolaresElectronico" id="MontoDolaresElectronico" inputmode="decimal" 
                               class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
                               placeholder="0.00" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Banco *</label>
                        <select asp-for="Banco" name="Banco" id="Banco" 
                                class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Seleccionar...</option>
                            @foreach (var banco in bancos)
                            {
                                <option value="@banco">@banco</option>
                            }
                        </select>
                    </div>
                </div>
                <!-- Fila 2: Tipo de cuenta al ancho -->
                <div class="mb-2">
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Tipo de Cuenta *</label>
                    <select asp-for="TipoCuenta" name="TipoCuenta" id="TipoCuenta" 
                            class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Seleccionar...</option>
                        @foreach (var tipo in tiposCuenta)
                        {
                            <option value="@tipo">@tipo</option>
                        }
                    </select>
                </div>
                <div class="text-xs text-right">
                    <span class="text-gray-600 dark:text-gray-400">Total: </span>
                    <span id="totalElectronicoValor" class="font-semibold text-green-600 dark:text-green-400">C$ 0.00</span>
                </div>
            </div>

            <!-- Resumen Total (solo para mixto) -->
            <div id="resumenTotal" style="display: none;" class="bg-purple-50 dark:bg-purple-900 border border-purple-200 dark:border-purple-800 rounded-lg p-3 mb-3">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-semibold text-gray-900 dark:text-white">Total del Pago:</span>
                    <span id="totalGeneralValor" class="text-sm font-bold text-purple-700 dark:text-purple-300">C$ 0.00</span>
                </div>
            </div>
        </div>

        <!-- Observaciones -->
        <div id="paso6" class="paso-oculto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-3 shadow-sm">
            <label for="Observaciones" class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Observaciones (Opcional)</label>
            <textarea asp-for="Observaciones" name="Observaciones" id="Observaciones" rows="2" 
                      class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      placeholder="Notas adicionales..."></textarea>
        </div>

        <!-- Botones -->
        <div class="flex items-center justify-end space-x-2">
            <a href="/pagos" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700">
                Cancelar
            </a>
            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium shadow-sm">
                Registrar Pago
            </button>
        </div>
    </form>
</div>

<style>
    .paso-oculto {
        display: none;
    }
    .paso-activo {
        display: block;
    }
    .tipo-pago-option input:checked + span,
    .tipo-pago-option:has(input:checked) {
        border-color: rgb(59 130 246);
        background-color: rgb(239 246 255);
    }
    .dark .tipo-pago-option:has(input:checked) {
        background-color: rgb(30 58 138);
    }
</style>

<script src="~/js/pagos-crear.js"></script>
<script>
    const clientesJson = @Html.Raw(clientesJson);
    // Asegurar que el tipo de cambio use formato con punto decimal (invariante)
    const tipoCambioRaw = @tipoCambio.ToString(System.Globalization.CultureInfo.InvariantCulture);
    PagoSystem.tipoCambio = parseFloat(tipoCambioRaw.toString().replace(',', '.')) || 36.80;
    // Validar que el tipo de cambio sea v√°lido
    if (isNaN(PagoSystem.tipoCambio) || PagoSystem.tipoCambio <= 0) {
        PagoSystem.tipoCambio = 36.80;
    }
    console.log('Tipo de cambio inicializado:', PagoSystem.tipoCambio);
    
    document.addEventListener('DOMContentLoaded', function() {
        ClienteManager.init(clientesJson);
        PagoSystem.init(); // Inicializar sistema de pagos (incluye validaci√≥n de inputs)
        
        // Event listeners para tipo de pago
        document.querySelectorAll('input[name="TipoPago"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.tipo-pago-option').forEach(opt => {
                    opt.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');
                });
                const label = this.closest('.tipo-pago-option');
                if (label) {
                    label.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900');
                }
                mostrarPaso5();
                if (window.mostrarCamposPago) window.mostrarCamposPago();
            });
        });
        
        // Event listener para cambio de moneda
        document.getElementById('Moneda')?.addEventListener('change', function() {
            actualizarMonedaEnInterfaz();
            if (window.actualizarTipoCambio) window.actualizarTipoCambio();
            if (window.mostrarCamposPago) window.mostrarCamposPago();
        });
        
        // Ajustar interfaz de moneda al cargar (por defecto C$ ‚Üí solo un input de monto f√≠sico)
        actualizarMonedaEnInterfaz();
        
        // Validar formulario antes de enviar
        document.getElementById('formPago')?.addEventListener('submit', function(e) {
            // Mostrar todos los pasos para que los campos requeridos sean validables
            document.querySelectorAll('.paso-oculto').forEach(paso => {
                paso.classList.remove('paso-oculto');
                paso.classList.add('paso-activo');
            });
            
            // Normalizar todos los montos: reemplazar coma por punto para evitar que el servidor interprete 898,40 como 89840
            const camposMontos = [
                'Monto',
                'MontoCordobasFisico',
                'MontoDolaresFisico',
                'MontoCordobasElectronico',
                'MontoDolaresElectronico',
                'MontoRecibidoFisico'
            ];
            camposMontos.forEach(id => {
                const input = document.getElementById(id);
                if (input && input.value) {
                    input.value = input.value.toString().replace(',', '.');
                }
            });
            
            // Forzar actualizaci√≥n de monto antes de validar
            if (window.actualizarMonto) {
                window.actualizarMonto();
            }
            
            // Validar campos requeridos manualmente
            const clienteId = document.getElementById('clienteId')?.value;
            const facturaId = document.getElementById('FacturaId')?.value;
            const facturaIds = document.getElementById('FacturaIds')?.value;
            const monto = document.getElementById('Monto')?.value;
            const moneda = document.getElementById('Moneda')?.value;
            const tipoPago = document.querySelector('input[name="TipoPago"]:checked')?.value;
            
            console.log('Validaci√≥n - ClienteId:', clienteId, 'FacturaId:', facturaId, 'FacturaIds:', facturaIds);
            
            if (!clienteId) {
                e.preventDefault();
                alert('Debe seleccionar un cliente');
                document.getElementById('clienteSearch')?.focus();
                return false;
            }
            
            // Validar facturas - verificar ambos campos
            const tieneFactura = (facturaId && facturaId.trim() !== '') || (facturaIds && facturaIds.trim() !== '');
            if (!tieneFactura) {
                e.preventDefault();
                alert('Debe seleccionar al menos una factura');
                return false;
            }
            
            if (!monto || parseFloat(monto) <= 0) {
                e.preventDefault();
                alert('El monto debe ser mayor a cero');
                return false;
            }
            
            if (!moneda) {
                e.preventDefault();
                alert('Debe seleccionar una moneda');
                return false;
            }
            
            if (!tipoPago) {
                // No mostrar alerta, solo asegurarse de que el usuario vea la secci√≥n de m√©todo de pago
                e.preventDefault();
                mostrarPaso4();
                mostrarPaso5();
                mostrarPaso6();
                const primerRadio = document.querySelector('input[name="TipoPago"]');
                if (primerRadio) {
                    primerRadio.focus();
                }
                return false;
            }
            
            // Validar que el monto recibido sea >= al monto a pagar (solo para pago f√≠sico o mixto)
            if (tipoPago === 'Fisico' || tipoPago === 'Mixto') {
                const montoRecibidoFisicoInput = document.getElementById('MontoRecibidoFisico');
                if (montoRecibidoFisicoInput && montoRecibidoFisicoInput.value) {
                    const parseNumero = (valor) => {
                        if (!valor || !valor.trim()) return 0;
                        const valorNormalizado = valor.trim().replace(',', '.');
                        return parseFloat(valorNormalizado) || 0;
                    };
                    
                    const montoRecibidoFisico = parseNumero(montoRecibidoFisicoInput.value);
                    const montoDebeTotal = parseNumero(monto);
                    const tipoCambioValor = PagoSystem.tipoCambio;
                    
                    // Calcular el monto base para comparar (en mixto y f√≠sico puede ser solo el monto f√≠sico)
                    let baseParaVuelto = montoDebeTotal; // Por defecto, el total en c√≥rdobas
                    if (tipoPago === 'Mixto' || tipoPago === 'Fisico') {
                        if (moneda === 'C$') {
                            const montoCordobasFisico = parseNumero(document.getElementById('MontoCordobasFisico')?.value);
                            if (montoCordobasFisico > 0) {
                                baseParaVuelto = montoCordobasFisico;
                            }
                        } else if (moneda === '$') {
                            const montoDolaresFisico = parseNumero(document.getElementById('MontoDolaresFisico')?.value);
                            if (montoDolaresFisico > 0) {
                                // Convertir a c√≥rdobas para la comparaci√≥n
                                baseParaVuelto = montoDolaresFisico * tipoCambioValor;
                            }
                        }
                    }
                    
                    // Convertir monto recibido a c√≥rdobas para comparar
                    let montoRecibidoEnCordobas = montoRecibidoFisico;
                    if (moneda === '$') {
                        montoRecibidoEnCordobas = montoRecibidoFisico * tipoCambioValor;
                    }
                    
                    // Comparar ambos en c√≥rdobas
                    // Usar tolerancia de 0.01 para manejar errores de precisi√≥n de punto flotante
                    const diferencia = montoRecibidoEnCordobas - baseParaVuelto;
                    if (diferencia < -0.01) {
                        e.preventDefault();
                        const monedaSimbolo = moneda === '$' ? '$' : 'C$';
                        // Convertir baseParaVuelto a la moneda seleccionada para el mensaje
                        let montoFormateado;
                        if (moneda === '$') {
                            montoFormateado = (baseParaVuelto / tipoCambioValor).toFixed(2).replace('.', ',');
                        } else {
                            montoFormateado = baseParaVuelto.toFixed(2).replace('.', ',');
                        }
                        alert(`El monto recibido debe ser mayor o igual a ${monedaSimbolo} ${montoFormateado}`);
                        montoRecibidoFisicoInput.focus();
                        // Forzar rec√°lculo para mostrar el error visual
                        if (window.calcularVueltoFisico) {
                            window.calcularVueltoFisico();
                        }
                        return false;
                    }
                }
            }
            
            // Validar campos espec√≠ficos seg√∫n tipo de pago
            if (tipoPago === 'Electronico' || tipoPago === 'Mixto') {
                const banco = document.getElementById('Banco')?.value;
                const tipoCuenta = document.getElementById('TipoCuenta')?.value;
                
                if (!banco) {
                    e.preventDefault();
                    alert('Debe seleccionar un banco');
                    return false;
                }
                
                if (!tipoCuenta) {
                    e.preventDefault();
                    alert('Debe seleccionar un tipo de cuenta');
                    return false;
                }
            }
        });
    });
    
    function mostrarPaso2() {
        document.getElementById('paso2')?.classList.remove('paso-oculto');
        document.getElementById('paso2')?.classList.add('paso-activo');
    }
    
    function mostrarPaso3() {
        document.getElementById('paso3')?.classList.remove('paso-oculto');
        document.getElementById('paso3')?.classList.add('paso-activo');
    }
    
    function mostrarPaso4() {
        document.getElementById('paso4')?.classList.remove('paso-oculto');
        document.getElementById('paso4')?.classList.add('paso-activo');
    }
    
    function mostrarPaso5() {
        document.getElementById('paso5')?.classList.remove('paso-oculto');
        document.getElementById('paso5')?.classList.add('paso-activo');
    }
    
    function mostrarPaso6() {
        document.getElementById('paso6')?.classList.remove('paso-oculto');
        document.getElementById('paso6')?.classList.add('paso-activo');
    }
    
    function actualizarMonedaEnInterfaz() {
        const moneda = document.getElementById('Moneda')?.value;
        const simbolo = moneda === '$' ? '$' : (moneda === 'Ambos' ? 'C$ y $' : 'C$');
        
        // Actualizar labels de monto principal (f√≠sico y electr√≥nico)
        if (moneda !== 'Ambos') {
            document.querySelectorAll('#labelMontoFisico1, #labelMontoElectronico1').forEach(el => {
                el.textContent = `Monto (${simbolo})`;
            });
        }
        
        // Campos de monto f√≠sico
        const grupoMontoCordobasFisico = document.getElementById('grupoMontoCordobasFisico');
        const grupoMontoDolaresFisico = document.getElementById('grupoMontoDolaresFisico');
        const montoCordobasFisico = document.getElementById('MontoCordobasFisico');
        const montoDolaresFisico = document.getElementById('MontoDolaresFisico');
        
        // Campos de recibido f√≠sico
        const grupoRecibidoUnico = document.getElementById('grupoRecibidoUnico');
        const grupoRecibidoCordobasFisico = document.getElementById('grupoRecibidoCordobasFisico');
        const grupoRecibidoDolaresFisico = document.getElementById('grupoRecibidoDolaresFisico');
        const montoRecibidoCordobasFisico = document.getElementById('MontoRecibidoCordobasFisico');
        const montoRecibidoDolaresFisico = document.getElementById('MontoRecibidoDolaresFisico');
        
        // Campos de monto electr√≥nico
        const grupoMontoCordobasElectronico = document.getElementById('grupoMontoCordobasElectronico');
        const grupoMontoDolaresElectronico = document.getElementById('grupoMontoDolaresElectronico');
        const montoCordobasElectronico = document.getElementById('MontoCordobasElectronico');
        const montoDolaresElectronico = document.getElementById('MontoDolaresElectronico');
        
        if (moneda === 'Ambos') {
            // Mostrar AMBOS campos de monto f√≠sico
            if (grupoMontoCordobasFisico) grupoMontoCordobasFisico.style.display = 'block';
            if (grupoMontoDolaresFisico) grupoMontoDolaresFisico.style.display = 'block';
            
            // Mostrar AMBOS campos de recibido f√≠sico
            if (grupoRecibidoUnico) grupoRecibidoUnico.style.display = 'none';
            if (grupoRecibidoCordobasFisico) grupoRecibidoCordobasFisico.style.display = 'block';
            if (grupoRecibidoDolaresFisico) grupoRecibidoDolaresFisico.style.display = 'block';
            
            // Electr√≥nico: mostrar ambos campos
            if (grupoMontoCordobasElectronico) grupoMontoCordobasElectronico.style.display = 'block';
            if (grupoMontoDolaresElectronico) grupoMontoDolaresElectronico.style.display = 'block';
        } else if (moneda === '$') {
            // Mostrar solo monto en d√≥lares para pago f√≠sico
            if (grupoMontoCordobasFisico) grupoMontoCordobasFisico.style.display = 'none';
            if (grupoMontoDolaresFisico) grupoMontoDolaresFisico.style.display = 'block';
            
            // Limpiar monto en c√≥rdobas f√≠sico
            if (montoCordobasFisico) montoCordobasFisico.value = '';
            
            // Mostrar solo recibido √∫nico
            if (grupoRecibidoUnico) grupoRecibidoUnico.style.display = 'block';
            if (grupoRecibidoCordobasFisico) grupoRecibidoCordobasFisico.style.display = 'none';
            if (grupoRecibidoDolaresFisico) grupoRecibidoDolaresFisico.style.display = 'none';
            if (montoRecibidoCordobasFisico) montoRecibidoCordobasFisico.value = '';
            if (montoRecibidoDolaresFisico) montoRecibidoDolaresFisico.value = '';
            
            // Electr√≥nico: mostrar solo monto en d√≥lares
            if (grupoMontoCordobasElectronico) grupoMontoCordobasElectronico.style.display = 'none';
            if (grupoMontoDolaresElectronico) grupoMontoDolaresElectronico.style.display = 'block';
            if (montoCordobasElectronico) montoCordobasElectronico.value = '';
        } else {
            // Mostrar solo monto en c√≥rdobas para pago f√≠sico
            if (grupoMontoCordobasFisico) grupoMontoCordobasFisico.style.display = 'block';
            if (grupoMontoDolaresFisico) grupoMontoDolaresFisico.style.display = 'none';
            
            // Limpiar monto en d√≥lares f√≠sico
            if (montoDolaresFisico) montoDolaresFisico.value = '';
            
            // Mostrar solo recibido √∫nico
            if (grupoRecibidoUnico) grupoRecibidoUnico.style.display = 'block';
            if (grupoRecibidoCordobasFisico) grupoRecibidoCordobasFisico.style.display = 'none';
            if (grupoRecibidoDolaresFisico) grupoRecibidoDolaresFisico.style.display = 'none';
            if (montoRecibidoCordobasFisico) montoRecibidoCordobasFisico.value = '';
            if (montoRecibidoDolaresFisico) montoRecibidoDolaresFisico.value = '';
            
            // Electr√≥nico: mostrar solo monto en c√≥rdobas
            if (grupoMontoCordobasElectronico) grupoMontoCordobasElectronico.style.display = 'block';
            if (grupoMontoDolaresElectronico) grupoMontoDolaresElectronico.style.display = 'none';
            if (montoDolaresElectronico) montoDolaresElectronico.value = '';
        }
        
        // Actualizar label del campo √∫nico de recibido
        if (moneda !== 'Ambos') {
            if (moneda === '$') {
                document.getElementById('monedaRecibidoLabel').textContent = '$';
            } else {
                document.getElementById('monedaRecibidoLabel').textContent = 'C$';
            }
        }
    }
    
    // Sobrescribir cargarFacturas para mostrar paso 2
    const originalCargarFacturas = window.cargarFacturas;
    window.cargarFacturas = function(clienteId) {
        originalCargarFacturas(clienteId);
        if (clienteId) {
            mostrarPaso2();
            document.getElementById('clienteSeleccionadoBadge')?.classList.remove('hidden');
        }
    };
    
    // Sobrescribir actualizarMonto para mostrar pasos siguientes
    const originalActualizarMonto = window.actualizarMonto;
    window.actualizarMonto = function() {
        originalActualizarMonto();
        const monto = parseFloat(document.getElementById('Monto')?.value || 0);
        if (monto > 0) {
            mostrarPaso3();
            mostrarPaso4();
        }
    };
    
    // Mostrar paso 6 cuando se selecciona tipo de pago
    document.querySelectorAll('input[name="TipoPago"]').forEach(radio => {
        radio.addEventListener('change', function() {
            mostrarPaso6();
        });
    });
</script>

